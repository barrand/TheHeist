<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPC Conversation Prototype - The Heist</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #0F0F0F;
            color: #FFFFFF;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        .objective-section {
            background: #1E1E1E;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #D4AF37;
        }

        .objective-section h1 {
            color: #D4AF37;
            font-size: 20px;
            margin-bottom: 12px;
        }

        .objective-section p {
            font-size: 14px;
            color: #B0B0B0;
            margin-bottom: 8px;
        }

        .context-section {
            background: #1E1E1E;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .context-section h2 {
            font-size: 16px;
            color: #D4AF37;
            margin-bottom: 8px;
        }

        .npc-header {
            background: #1E1E1E;
            padding: 16px;
            border-radius: 12px 12px 0 0;
            border-bottom: 1px solid #333;
        }

        .npc-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .npc-traits {
            font-size: 12px;
            color: #B0B0B0;
            font-style: italic;
        }

        .chat-container {
            background: #1E1E1E;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
        }

        .chat-messages {
            padding: 16px;
            height: 400px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.npc {
            text-align: left;
        }

        .message.player {
            text-align: right;
        }

        .message-bubble {
            display: inline-block;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.npc .message-bubble {
            background: #2A2A2A;
            color: #FFFFFF;
            border: 1px solid #3A3A3A;
        }

        .message.player .message-bubble {
            background: #D4AF37;
            color: #0F0F0F;
        }

        .message-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }

        .input-area {
            padding: 16px;
            border-top: 1px solid #333;
        }

        .input-wrapper {
            display: flex;
            gap: 8px;
        }

        #messageInput {
            flex: 1;
            background: #2A2A2A;
            border: 1px solid #3A3A3A;
            border-radius: 8px;
            padding: 12px;
            color: #FFFFFF;
            font-size: 14px;
            font-family: inherit;
        }

        #messageInput:focus {
            outline: none;
            border-color: #D4AF37;
        }

        #sendButton {
            background: #D4AF37;
            color: #0F0F0F;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #sendButton:hover {
            background: #E5C158;
        }

        #sendButton:disabled {
            background: #555;
            cursor: not-allowed;
            color: #888;
        }

        .loading {
            text-align: left;
            color: #888;
            font-style: italic;
            font-size: 14px;
            padding: 12px;
        }

        .success-message {
            background: #1E3A1E;
            border: 2px solid #4CAF50;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
        }

        .success-message h2 {
            color: #4CAF50;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .hint {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
            font-style: italic;
        }

        .debug-info {
            background: #1A1A1A;
            border: 1px solid #333;
            padding: 12px;
            margin-top: 12px;
            border-radius: 8px;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            color: #888;
            max-height: 200px;
            overflow-y: auto;
        }

        .api-key-input {
            background: #2A2A2A;
            border: 1px solid #D4AF37;
            border-radius: 8px;
            padding: 12px;
            color: #FFFFFF;
            width: 100%;
            margin-top: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #E5C158;
        }

        .setup-section {
            background: #1E1E1E;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #D4AF37;
        }

        .button {
            background: #D4AF37;
            color: #0F0F0F;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 12px;
        }

        .button:hover {
            background: #E5C158;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Section (shown initially) -->
        <div id="setupSection" class="setup-section">
            <h1 style="color: #D4AF37; margin-bottom: 16px;">üé≠ NPC Conversation Prototype</h1>
            <p style="margin-bottom: 16px;">This prototype lets you test free-form conversations with AI-powered NPCs.</p>
            <p style="font-size: 12px; color: #888; margin-bottom: 8px;">Using: <strong>Gemini 2.5 Flash Lite</strong> (fast & cheap for NPC chats)</p>
            <p style="font-size: 12px; color: #888; margin-bottom: 16px;">‚ú® <strong>Dynamic Difficulty:</strong> Choose how hard it is to get information. Can you succeed without raising suspicion?</p>
            
            <label for="difficultySelect" style="display: block; margin-bottom: 8px; font-weight: 600;">
                Select Difficulty:
            </label>
            <select id="difficultySelect" class="api-key-input" style="cursor: pointer; padding: 16px;">
                <option value="easy">üü¢ EASY - Chatty NPC, very forgiving</option>
                <option value="medium" selected>üü° MEDIUM - Normal challenge, be careful</option>
                <option value="hard">üî¥ HARD - Paranoid NPC, requires finesse</option>
            </select>
            <p class="hint" style="margin-top: 8px;">Easy = hard to fail, Medium = balanced, Hard = social engineering required!</p>
            
            <label for="apiKeyInput" style="display: block; margin-bottom: 8px; margin-top: 20px; font-weight: 600;">
                Gemini API Key:
            </label>
            <input 
                type="password" 
                id="apiKeyInput" 
                class="api-key-input" 
                placeholder="Paste your Gemini API key here"
            >
            <p class="hint">Your API key is stored only in your browser session and never sent anywhere except Google's API.</p>
            
            <button class="button" onclick="startGame()">Start Game</button>
        </div>

        <!-- Game Section (hidden initially) -->
        <div id="gameSection" style="display: none;">
            <!-- Objective -->
            <div class="objective-section">
                <h1>üéØ YOUR OBJECTIVE</h1>
                <p><strong>Get Intel on Armored Train Car Security</strong></p>
                <p>Your crew is planning to rob an armored train carrying a priceless artifact in Car 7. You need details about the security systems protecting that car. A passenger on the platform has been waiting a long time and might have overheard something useful from the conductor.</p>
                <p id="difficultyDisplay" style="margin-top: 12px; padding: 8px; background: #2A2A2A; border-radius: 6px; font-size: 13px;"></p>
            </div>

            <!-- Context -->
            <div class="context-section">
                <h2>üìç Current Location: Train Platform - Evening</h2>
                <p>You're standing on a busy train platform. Passengers mill about, checking schedules on overhead displays. Sitting on a bench with shopping bags is Brenda Williams, a friendly-looking woman in her 40s wearing a cardigan. She's sipping coffee and scrolling through her phone with a bored expression. She's clearly been waiting a while.</p>
                <p style="margin-top: 8px; color: #D4AF37;">üí¨ She looks like she'd enjoy some company and conversation.</p>
            </div>

            <!-- NPC Chat -->
            <div class="npc-header">
                <div class="npc-name">BRENDA WILLIAMS</div>
                <div class="npc-traits">train passenger, chatty, bored, loves gossip</div>
                <img src="brenda_williams.png" style="width: 280px; height: 280px; border-radius: 16px; margin-top: 16px; border: 3px solid #D4AF37; display: block;" onerror="this.style.display='none'">
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message npc">
                        <div class="message-label">Brenda Williams</div>
                        <div class="message-bubble" id="initialGreeting">
                            Excuse me, do you know if this train is delayed?
                        </div>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-wrapper">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Type your response..."
                            onkeypress="if(event.key==='Enter') sendMessage()"
                        >
                        <button id="sendButton" onclick="sendMessage()">Send</button>
                    </div>
                    <div class="hint">üí° Brenda loves to gossip but watch your approach. Too direct about security = suspicious. Build natural rapport! <span style="float: right;"><a href="javascript:location.reload()" style="color: #888;">üîÑ Reset</a></span></div>
                </div>
            </div>

            <!-- Success Message (hidden initially) -->
            <div id="successMessage" class="success-message" style="display: none;">
                <h2>üéâ INFORMATION OBTAINED!</h2>
                <p id="successText"></p>
            </div>

            <!-- Failure Message (hidden initially) -->
            <div id="failureMessage" style="display: none; background: #3A1E1E; border: 2px solid #E53935; padding: 20px; border-radius: 12px; text-align: center; margin-top: 20px;">
                <h2 style="color: #E53935; font-size: 24px; margin-bottom: 12px;">‚ùå MISSION FAILED!</h2>
                <p id="failureText" style="color: #FFFFFF;"></p>
            </div>
        </div>
    </div>

    <script type="module">
        let conversationHistory = [];
        let apiKey = '';
        let infoObtained = false;
        let missionFailed = false;
        let difficulty = 'medium';
        let suspicionLevel = 0; // Track how suspicious Eddie is getting

        // =====================================================
        // OBJECTIVE CONFIGURATION
        // =====================================================
        
        const OBJECTIVE_INFO = {
            description: "Security details about the armored train Car 7 (laser grids, pressure plates, security protocols)",
            keywords: ["car 7", "laser grid", "pressure plate", "security protocol", "laser", "armored car"],  // Fallback if LLM fails
            successMessage: "You learned that Car 7 has laser grids AND pressure plates protecting the artifact! This intel is critical for the heist!"
        };
        
        // =====================================================
        // NPC PROMPTS BY DIFFICULTY
        // =====================================================
        
        const NPC_PROMPTS = {
            easy: `You are roleplaying as Brenda Williams, a train passenger waiting on a platform. You are having a real-time conversation with a player in a heist game.

üü¢ DIFFICULTY: EASY - You're VERY bored and LOVE having someone to talk to.

YOUR PERSONALITY:
- Black woman in her 40s, friendly and chatty
- LOVE to gossip and share information
- Been waiting for this train for 45 minutes - SO BORED
- Will talk to anyone who seems friendly
- Enjoy feeling like you know things others don't

YOUR BACKGROUND:
- Regular commuter on this train line
- Been here so long you've overheard LOTS of conversations
- Just heard the conductor talking about Car 7's new security
- Love snacking when you wait (currently wishing you had chips)

CRITICAL INFORMATION (share relatively easily):
üîë **CAR 7 SECURITY**: You overheard the conductor say Car 7 (the armored car) has "laser grids" and "pressure plates" as part of a new security protocol. Sounds fancy!

CONVERSATION GUIDELINES (EASY MODE):
- You're LONELY and BORED - happy to chat with anyone friendly
- Start complaining about the wait and the train service
- If player is nice and conversational, you'll naturally gossip
- You might mention you're hungry for a snack
- Love sharing what you overheard - makes you feel important
- Only shut down if player is rude or dismissive
- You trust people easily

RESPOND AS BRENDA:
- Write ONLY Brenda's dialogue (2-3 sentences)
- Stay in character
- Be chatty and friendly
- Use casual, conversational language
- Complain about the wait, gossip freely`,

            medium: `You are roleplaying as Brenda Williams, a train passenger waiting on a platform. You are having a real-time conversation with a player in a heist game.

üü° DIFFICULTY: MEDIUM - You're chatty but a bit more cautious about strangers.

YOUR PERSONALITY:
- Black woman in her 40s, friendly but street-smart
- Love to talk but not naive
- Been waiting for train for 30 minutes - bored but alert
- Will chat with people who seem genuine
- Slightly suspicious of people who ask too many weird questions

YOUR BACKGROUND:
- Regular commuter, know this station well
- Overheard conductor talking about Car 7's security upgrades
- Like to gossip but don't want to seem nosy or weird
- Currently a bit hungry, wouldn't mind a snack

CRITICAL INFORMATION (share if convinced):
üîë **CAR 7 SECURITY**: Overheard conductor mention "laser grids" and "pressure plates" protecting Car 7 (the armored car). But you'll only share if player seems trustworthy.

CONVERSATION GUIDELINES (MEDIUM MODE):
- Start friendly but feel out the person first
- If player is too direct about the train or Car 7, get cautious
- If player seems suspicious or pushy, deflect
- You'll share info if:
  * Player builds genuine rapport
  * They seem like a regular friendly person
  * Conversation feels natural (not forced)
  * They don't seem like they're "up to something"
- Watch for red flags: too many questions, weird interest in security

FAILURE TRIGGERS:
- Direct questions about the armored car or security
- Acting suspicious or nervous
- Pushing too hard for information
- Not engaging in normal small talk first
- Seeming like a criminal or up to no good

RESPOND AS BRENDA:
- Write ONLY Brenda's dialogue (2-3 sentences)
- Be friendly but test their intentions
- Share the gossip if they earn trust
- Use conversational language`,

            hard: `You are roleplaying as Brenda Williams, a train passenger waiting on a platform. You are having a real-time conversation with a player in a heist game.

üî¥ DIFFICULTY: HARD - You're on EDGE today. Someone tried to pickpocket you earlier. You're suspicious.

YOUR PERSONALITY:
- Black woman in her 40s, street-smart and cautious
- Usually friendly but someone tried to ROB YOU earlier today
- HIGHLY SUSPICIOUS of strangers approaching you
- Will shut down or walk away if anyone seems off
- Need EXCELLENT social engineering to get you talking

YOUR BACKGROUND:
- Regular commuter but had a bad experience today (attempted robbery)
- Overheard conductor talk about Car 7's security (laser grids, pressure plates)
- Clutching your purse tightly, not in the mood for strangers
- Wondering if people approaching you are trying to scam or rob you

CRITICAL INFORMATION (very hard to get):
üîë **CAR 7 SECURITY**: You know about the laser grids and pressure plates but you're PARANOID. Only someone with perfect approach and genuine reason could get you to share.

CONVERSATION GUIDELINES (HARD MODE):
- Start GUARDED and SUSPICIOUS
- Any red flags = you end conversation and move away
- You'll shut down if:
  * Stranger approaches too confidently
  * Questions feel weird or probing
  * Player mentions the armored car or security
  * They seem like they want something from you
  * Not respecting your personal space
- You might share ONLY if:
  * Player seems genuinely concerned/helpful
  * Perfect empathy and social skills
  * Builds trust very slowly and naturally
  * Offers help or kindness first
  * NO agenda whatsoever

FAILURE TRIGGERS (instant shutdown):
- Direct questions about the train or cars
- Getting too close physically
- Asking personal questions
- Mentioning valuable items or security
- Seeming like a scammer or criminal
- Pushy behavior of any kind
- Not reading social cues

RESPOND AS BRENDA:
- Write ONLY Brenda's dialogue (1-2 sentences)
- Be guarded and curt
- Keep responses short and defensive
- Say things like "I don't know you" or "Leave me alone"
- End conversations that feel wrong
- Make player work VERY HARD for trust`
        };

        async function checkIfMissionFailed(npcResponse) {
            // Check if Eddie has shut down the conversation (failure)
            const failurePrompt = `You are evaluating whether an NPC has ended a conversation due to suspicion or distrust.

NPC'S LATEST RESPONSE:
"${npcResponse}"

QUESTION: Has the NPC shut down the conversation, kicked out the player, or refused to continue talking due to suspicion?

Look for phrases like:
- "We're done here" / "Get out" / "Leave"
- "You a cop?" (accusatory tone)
- "I don't know you" / "I don't trust you"
- "This conversation is over"
- Clear rejection or hostility
- Refusing to engage further

Answer with ONLY "YES" if conversation is over/failed, or "NO" if still talking:`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            role: 'user',
                            parts: [{ text: failurePrompt }]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 10,
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                    const evaluation = data.candidates[0].content.parts[0].text.trim().toUpperCase();
                    
                    console.log('Failure check:', evaluation);
                    
                    if (evaluation.includes('YES')) {
                        setTimeout(() => {
                            showFailure("Brenda got suspicious and walked away. She's probably telling station security about you right now. Mission failed!");
                        }, 500);
                        missionFailed = true;
                    }
                }
            } catch (error) {
                console.error('Error checking failure:', error);
            }
        }

        async function checkIfInfoRevealed(npcResponse) {
            // Use LLM to evaluate if the critical information was revealed
            const evaluationPrompt = `You are evaluating whether an NPC has revealed critical information to a player.

OBJECTIVE: The player is trying to find out: "${OBJECTIVE_INFO.description}"

NPC'S LATEST RESPONSE:
"${npcResponse}"

QUESTION: Did the NPC reveal the information the player is seeking?

Answer with ONLY "YES" or "NO" based on these criteria:
- YES if the NPC clearly stated the specific information (exact timing, code, name, etc.)
- YES even if the information was phrased casually or embedded in conversation
- NO if the information was vague, hinted at, or not specific enough
- NO if the NPC is still being evasive or hasn't given the key detail yet

Your answer (YES or NO):`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            role: 'user',
                            parts: [{ text: evaluationPrompt }]
                        }],
                        generationConfig: {
                            temperature: 0.1,  // Low temperature for consistent evaluation
                            maxOutputTokens: 10,
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                    const evaluation = data.candidates[0].content.parts[0].text.trim().toUpperCase();
                    
                    console.log('Info revealed check:', evaluation);
                    
                    if (evaluation.includes('YES')) {
                        setTimeout(() => {
                            showSuccess(OBJECTIVE_INFO.successMessage);
                        }, 500);
                        infoObtained = true;
                    }
                }
            } catch (error) {
                console.error('Error checking info revelation:', error);
                // Fallback to keyword detection if LLM evaluation fails
                const lowerResponse = npcResponse.toLowerCase();
                const foundKeyword = OBJECTIVE_INFO.keywords.some(keyword => 
                    lowerResponse.includes(keyword.toLowerCase())
                );
                
                if (foundKeyword) {
                    setTimeout(() => {
                        showSuccess(OBJECTIVE_INFO.successMessage);
                    }, 500);
                    infoObtained = true;
                }
            }
        }

        window.startGame = function() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            difficulty = document.getElementById('difficultySelect').value;
            
            if (!apiKey) {
                alert('Please enter your Gemini API key');
                return;
            }
            
            if (!apiKey.startsWith('AIza')) {
                alert('Invalid API key format. Gemini keys start with "AIza"');
                return;
            }
            
            // Set difficulty display
            const difficultyText = {
                easy: 'üü¢ EASY: Brenda is bored and loves to chat. Be friendly and she\'ll gossip.',
                medium: 'üü° MEDIUM: Brenda is cautious. Build genuine rapport, don\'t be pushy.',
                hard: 'üî¥ HARD: Brenda was almost robbed today. She\'s suspicious of everyone.'
            };
            document.getElementById('difficultyDisplay').textContent = difficultyText[difficulty];
            
            // Set initial greeting based on difficulty
            const greetings = {
                easy: 'Ugh, this train is SO late! Been waiting forever. I swear, this service gets worse every year...',
                medium: 'Excuse me, do you know if this train is delayed?',
                hard: 'What? I\'m sorry, I don\'t have any change.'
            };
            document.getElementById('initialGreeting').textContent = greetings[difficulty];
            
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';
            document.getElementById('messageInput').focus();
        };

        window.sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            if (infoObtained || missionFailed) return;
            
            // Disable input
            input.value = '';
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            // Add player message
            addMessage('player', message, 'You');
            
            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loading';
            loadingDiv.textContent = 'Brenda is typing...';
            document.getElementById('chatMessages').appendChild(loadingDiv);
            scrollToBottom();
            
            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                parts: [{ text: message }]
            });
            
            try {
                // Call Gemini API - using gemini-2.5-flash-lite (cheap & fast for NPC chats)
                // Use the appropriate NPC prompt based on selected difficulty
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        system_instruction: {
                            parts: [{ text: NPC_PROMPTS[difficulty] }]
                        },
                        contents: conversationHistory,
                        generationConfig: {
                            temperature: 0.9,
                            maxOutputTokens: 300,
                        }
                    })
                });
                
                const data = await response.json();
                
                // Remove loading
                document.getElementById('loading')?.remove();
                
                // Debug: log the response
                console.log('API Response:', data);
                
                if (data.error) {
                    console.error('API Error:', data.error);
                    addMessage('npc', `[API Error: ${data.error.message}]`, 'System');
                    return;
                }
                
                if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                    const npcResponse = data.candidates[0].content.parts[0].text.trim();
                    
                    // Add to conversation history
                    conversationHistory.push({
                        role: 'model',
                        parts: [{ text: npcResponse }]
                    });
                    
                    // Add NPC message
                    addMessage('npc', npcResponse, 'Brenda Williams');
                    
                    // First check if mission failed (Eddie shut down)
                    if (!missionFailed && !infoObtained) {
                        await checkIfMissionFailed(npcResponse);
                    }
                    
                    // Then check if critical info was revealed (only if not failed)
                    if (!infoObtained && !missionFailed) {
                        checkIfInfoRevealed(npcResponse);
                    }
                } else if (data.candidates && data.candidates[0]?.finishReason) {
                    console.error('Blocked by safety filters:', data.candidates[0].finishReason);
                    addMessage('npc', `[Response blocked: ${data.candidates[0].finishReason}. Try a different approach.]`, 'System');
                } else {
                    console.error('Unexpected response format:', data);
                    addMessage('npc', "[Unexpected response format. Check console for details.]", 'System');
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading')?.remove();
                addMessage('npc', `[Error: ${error.message}. Check console for details.]`, 'System');
            }
            
            // Re-enable input (unless mission ended)
            input.disabled = false;
            document.getElementById('sendButton').disabled = false;
            if (!infoObtained && !missionFailed) {
                input.focus();
            }
        };

        function addMessage(type, text, label) {
            const messagesDiv = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const labelDiv = document.createElement('div');
            labelDiv.className = 'message-label';
            labelDiv.textContent = label;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.textContent = text;
            
            messageDiv.appendChild(labelDiv);
            messageDiv.appendChild(bubbleDiv);
            messagesDiv.appendChild(messageDiv);
            
            scrollToBottom();
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            successText.textContent = message;
            successDiv.style.display = 'block';
            
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendButton').disabled = true;
        }

        function showFailure(message) {
            const failureDiv = document.getElementById('failureMessage');
            const failureText = document.getElementById('failureText');
            failureText.textContent = message;
            failureDiv.style.display = 'block';
            
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendButton').disabled = true;
        }
    </script>
</body>
</html>
